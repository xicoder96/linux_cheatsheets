# 4-Way Handshake -Theory

- The 4-way handshake is the process of exchanging 4 messages between an access point (authenticator) and the client device (supplicant) to generate some encryption keys which can be used to encrypt actual data sent over Wireless medium.

## Terminolgies

1. PTK (Pairwise Transit Key) 
- Pairwise transit key is used to encrypt all unicast traffic between a client station and the access point. 
- PTK is unique between a client station and access point.
- To generate PTK, client device and access point need the following information.
    - Anonce - is a random number generated by an access point (authenticator), 
    - Snonce a random number generated by the client device (supplicant). 
    - MAC addresses of supplicant (client device) and MAC address of authenticator (access point). 
    - PRF is a pseudo-random function which is applied to all the input.
  
```txt
    PTK = PRF (PMK + Anonce + SNonce + Mac (AA)+ Mac (SA))
```   
- **PTK is dependent on another high-level key PMK (pairwise master key)**

2. GTK (Group Temporal Key)
- Group temporal key is used to encrypt all broadcast and multicast traffic between an access point and multiple client devices. 
- GTK is the key which is shared between all client devices associated with 1 access point. 
- For every access point, there will be a different GTK which will be shared between its associated devices.  
- GTK is dependent on another high-level key GMK (group master key) discussed below.

3. PMK (Pairwise Master Key)
- Pairwise master is key generated from master session key (MSK). 
- In case of WPA2/PSK when device authenticates with access point the PSK becomes PMK.
- PMK resides on all stations as in AP and client devices, so we do not need to share this information. We use this information to create PTK which are used for unicast data encryption. 

4. GMK (Group Master Key):
- Group master key is used in a 4-way handshake to create GTK discussed above. 
- GTK is generated on every access point and shared with the devices connected to this AP.

5. MSK (Master Session Key): 
- The master session is the first key which is generated either from 802.1X/EAP or derived from PSK authentication.

- This is the view from top to bottom. 3 level keys
    1. The first level key that is generated is MSK during the process of 802.1X/EAP or PSK authentication.
    2. The second level key is generated from MSK is PMK and GMK. PMK is used to generate PTK and GMK is used to create GTK.
    3. Third level keys are the actual keys used for data encryption. 

## 4-Way Handshake in Action: 
- Instead of sending the password to the access points there are EAPOL (Extensible authentication protocol over LAN) messages exchange happens.
- A device going through states from authentication to association. 
- Once the device is authenticated and associated and now security will be checked, and 4-way handshake will start.

- Message1 
    - **Access point sends EAPOL message with Anonce (random number)** to the device to generate PTK. 
    - Don’t forget **client device knows Ap’s MAC** because its connected to it. 
    - It has **PMK, Snonce and its own MAC address.** 
    - Once it receives Anonce from access point it has all the inputs to create the PTK.      
```txt
    PTK = PRF (PMK + Anonce + SNonce + Mac (AA)+ Mac (SA))
```   
- Message2
    -  Once the device has created its PTK it sends out SNonce which is needed by the access point to generate PTK as well. 
    - The device sends EAPOL to AP message2 with MIC (message integrity check) to make sure when the access point can verify whether this message corrupted or modified. 
    - Once SNonce received by the AP it can generate PTK as well for unicast traffic encryption.
    - This is the second message going from the client device to AP with Snonce and MIC field set to 1.
 - Message 3
    - EAPOL message3 is sent from AP to client device containing GTK. 
    - AP creates GTK without the involvement of the client from GMK.
 - Message 4
    - Fourth and last EPOL message will be sent from the client to AP just to confirm that Keys have been installed. 

> 4 way handshake packets will be shown in wireshark as `QoS Data`. (Quality of Service packet)

- **Result** - Control port unlocked: 
    - Once the 4-way handshake is completed successfully virtual control port which blocks all the traffic will be open and now encrypted traffic can flow. 
    - Now all unicast traffic will be encrypted with PTK and all multicast traffic will be encrypted via GTK which created in the 4-way handshake process.


## References
- [4-Way Handshake - wifi-professionals](https://www.wifi-professionals.com/2019/01/4-way-handshake)
- [Authentication Frame Misunderstanding](http://www.wifi-professionals.com/2018/08/authentication-frame-misunderstanding)
- [Four-way Handshake in WPA-Personal (WPA-PSK) - Stackexchange](https://security.stackexchange.com/questions/17767/four-way-handshake-in-wpa-personal-wpa-psk)
- [CWSP – 4 Way Handshake - mrncciew.com](https://mrncciew.com/2014/08/19/cwsp-4-way-handshake/)